---
import Layout from "../../layouts/BlogPost.astro";
import { getCollection, render } from "astro:content";

const base = import.meta.env.BASE_URL;
const resolveCover = (cover) => {
  if (!cover) return null;
  if (cover.startsWith("/")) {
    return `${base}${cover.replace(/^\//, "")}`;
  }
  return cover;
};
const heroFallbacks = [
  `${base}images/pages/LF_Chi_Siamo.png`,
  `${base}images/pages/LF_Home.png`,
  `${base}images/pages/LF_Home2.png`,
  `${base}images/pages/LF_Metodo.png`,
  `${base}images/pages/LF_Prodotti.png`,
  `${base}images/pages/LF_Reti.png`,
  `${base}images/pages/LF_Spare_Contesti.png`,
];

export async function getStaticPaths() {
  const posts = (await getCollection("blog")).filter((post) => !post.data.draft);
  return posts.map((post) => ({
    params: {
      slug: post.slug ?? post.id.replace(/\.(md|mdx)$/i, ""),
    },
  }));
}

const toDate = (value) => (value instanceof Date ? value : new Date(value));

const { slug } = Astro.params;
const post = (await getCollection("blog")).find(
  (entry) =>
    (entry.slug ?? entry.id.replace(/\.(md|mdx)$/i, "")) === slug,
);
if (!post || post.data.draft) {
  throw new Error("Not found");
}

const { Content } = await render(post);
const allPosts = (await getCollection("blog")).filter((entry) => !entry.data.draft);
const getSlug = (entry) => entry.slug ?? entry.id.replace(/\.(md|mdx)$/i, "");
const related = allPosts
  .filter((entry) => entry !== post)
  .sort((a, b) => toDate(b.data.date).valueOf() - toDate(a.data.date).valueOf())
  .slice(0, 3);
const hashSlug = (value = "") =>
  [...value].reduce((acc, char) => acc + char.charCodeAt(0), 0);
const heroImage =
  resolveCover(post.data.cover) ??
  heroFallbacks[hashSlug(getSlug(post)) % heroFallbacks.length];
---

<Layout title={post.data.title} description={post.data.excerpt ?? ""}>
  <section class="mt-0">
    <div class="blog-hero full-bleed">
      <img
        src={heroImage}
        alt=""
        class="blog-hero__img"
        loading="eager"
        decoding="async"
      />
      <div class="blog-hero__scrim" aria-hidden="true"></div>
      <div class="blog-hero__title">
        <p class="blog-hero__crumb">
          <a href={`${base}blog/`} class="blog-hero__crumb-link">
            Blog
          </a>{" "}
          / {post.data.title}
        </p>
        <h1 class="blog-hero__heading">{post.data.title}</h1>
      </div>
    </div>
    <div class="max-w-3xl">
      {post.data.excerpt && (
        <p class="mt-6 text-lg text-slate-600">{post.data.excerpt}</p>
      )}
    </div>
  </section>

  <section class="mt-8">
    <div class="max-w-3xl">
      <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
        <span>{toDate(post.data.date).toLocaleDateString("it-IT")}</span>
        {post.data.tags?.map((tag) => (
          <span class="rounded-full border border-slate-200 px-2 py-0.5 uppercase tracking-[0.14em] opacity-70">
            {tag}
          </span>
        ))}
      </div>

      <div class="mt-8 border-t border-slate-200"></div>

      <article class="prose mt-8">
        <Content />
      </article>

      <div class="mt-12 flex justify-center">
        <a
          href={`${base}blog/`}
          class="!text-white inline-flex items-center justify-center rounded-xl px-5 py-3 text-sm font-semibold text-white hover:opacity-90 transition"
          style="background: var(--brand);"
        >
          Torna agli articoli
        </a>
      </div>
    </div>
  </section>

  {related.length > 0 && (
    <section class="mt-16">
      <div class="max-w-5xl">
        <h3 class="text-2xl md:text-3xl font-semibold" style="color: var(--brand-dark);">
          Articoli correlati
        </h3>
        <div class="mt-6 grid gap-5 md:grid-cols-3">
          {related.map((entry) => (
            <a
              href={`${base}blog/${getSlug(entry)}/`}
              class="group overflow-hidden rounded-2xl border border-slate-200 bg-white transition hover:-translate-y-0.5 hover:shadow-md"
            >
              <div class="aspect-[16/9] overflow-hidden bg-slate-100">
                <img
                  src={resolveCover(entry.data.cover) ?? heroFallbacks[hashSlug(getSlug(entry)) % heroFallbacks.length]}
                  alt={entry.data.title}
                  class="h-full w-full object-cover transition duration-700 group-hover:scale-105"
                  loading="lazy"
                  decoding="async"
                />
              </div>
              <div class="p-4">
                <p class="text-xs uppercase tracking-[0.14em] text-slate-400">
                  {toDate(entry.data.date).toLocaleDateString("it-IT")}
                </p>
                <h4 class="mt-2 text-base font-semibold text-slate-800">
                  {entry.data.title}
                </h4>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}
</Layout>

<style>
  :global(main) {
    padding-top: 0;
  }

  .blog-hero {
    position: relative;
    height: 62svh;
    min-height: 360px;
    margin-top: 0;
    overflow: hidden;
    border-radius: 0;
    box-shadow: var(--box-shadow);
  }

  .blog-hero__img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .blog-hero__scrim {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.0) 40%, rgba(0, 0, 0, 0.6) 100%);
  }

  .blog-hero__title {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    padding: clamp(1.2rem, 3.2vw, 2.8rem);
    gap: 0.4rem;
  }

  .blog-hero__crumb {
    margin: 0;
    font-size: 0.75rem;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.7);
    text-align: center;
  }

  .blog-hero__crumb-link {
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
  }

  .blog-hero__crumb-link:hover {
    color: #fff;
  }

  .blog-hero__heading {
    color: #fff;
    font-weight: 700;
    letter-spacing: -0.02em;
    font-size: clamp(2rem, 5vw, 3.2rem);
    line-height: 1.05;
    text-align: center;
    text-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
  }

  .prose :global(p) {
    margin: 1rem 0;
    color: rgb(71 85 105);
    line-height: 1.8;
  }
  .prose :global(h3) {
    margin-top: 2rem;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--brand-dark);
  }
  .prose :global(h4) {
    margin-top: 1.5rem;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--brand-dark);
  }
  .prose :global(a) {
    text-decoration: underline;
  }
  .prose :global(img) {
    margin: 1.5rem 0;
    border-radius: 16px;
    border: 1px solid rgba(0, 0, 0, 0.08);
  }
  .prose :global(iframe) {
    width: 100%;
    height: auto;
    aspect-ratio: 16 / 9;
    border-radius: 16px;
  }
  .prose :global(ul) {
    margin: 1rem 0;
    padding-left: 1.2rem;
    list-style: disc;
    color: rgb(71 85 105);
  }
  .prose :global(blockquote) {
    margin: 1.5rem 0;
    padding-left: 1rem;
    border-left: 3px solid rgba(0, 0, 0, 0.2);
    color: rgb(71 85 105);
  }
</style>
