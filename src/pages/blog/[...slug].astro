---
import Layout from "../../layouts/BlogPost.astro";
import BannerStrip from "../../components/BannerStrip.astro";
import Hero from "../../components/Hero.astro";
import { getCollection, render } from "astro:content";

const base = import.meta.env.BASE_URL;
const heroImg = `${base}images/pages/LF_Home2.png`;
const resolveCover = (cover) => {
  if (!cover) return "";
  if (cover.startsWith("/")) {
    return `${base}${cover.replace(/^\//, "")}`;
  }
  return cover;
};

export async function getStaticPaths() {
  const posts = (await getCollection("blog")).filter((post) => !post.data.draft);
  return posts.map((post) => ({
    params: {
      slug: post.slug ?? post.id.replace(/\.(md|mdx)$/i, ""),
    },
  }));
}

const toDate = (value) => (value instanceof Date ? value : new Date(value));

const { slug } = Astro.params;
const post = (await getCollection("blog")).find(
  (entry) =>
    (entry.slug ?? entry.id.replace(/\.(md|mdx)$/i, "")) === slug,
);
if (!post || post.data.draft) {
  throw new Error("Not found");
}

const { Content } = await render(post);
---

<Layout title={post.data.title} description={post.data.excerpt ?? ""}>
  <Hero
    eyebrow=" "
    title={post.data.title}
    subtitle={post.data.excerpt ?? ""}
    image={heroImg}
    imageAlt="Dettaglio di uno spazio di lavoro"
    align="left"
    size="md"
  />

  <section>
    <BannerStrip title="BLOG" />
  </section>

  <article class="mt-10">
    <div class="max-w-3xl">
      <div class="flex flex-wrap gap-2 text-xs text-slate-500">
        <span>{toDate(post.data.date).toLocaleDateString("it-IT")}</span>
        {post.data.tags?.map((tag) => (
          <span class="rounded-full border border-slate-200 px-2 py-0.5">
            {tag}
          </span>
        ))}
      </div>

      {post.data.cover && (
        <img
          class="mt-6 rounded-2xl border border-slate-200"
          src={resolveCover(post.data.cover)}
          alt=""
        />
      )}

      <div class="prose mt-8">
        <Content />
      </div>
    </div>
  </article>
</Layout>

<style>
  :global(main) {
    padding-top: 0;
  }

  .prose :global(p) {
    margin: 1rem 0;
    color: rgb(71 85 105);
    line-height: 1.8;
  }
  .prose :global(h2) {
    margin-top: 2rem;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--brand-dark);
  }
  .prose :global(h3) {
    margin-top: 1.5rem;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--brand-dark);
  }
  .prose :global(a) {
    text-decoration: underline;
  }
  .prose :global(img) {
    margin: 1.5rem 0;
    border-radius: 16px;
    border: 1px solid rgba(0, 0, 0, 0.08);
  }
  .prose :global(ul) {
    margin: 1rem 0;
    padding-left: 1.2rem;
    list-style: disc;
    color: rgb(71 85 105);
  }
  .prose :global(blockquote) {
    margin: 1.5rem 0;
    padding-left: 1rem;
    border-left: 3px solid rgba(0, 0, 0, 0.2);
    color: rgb(71 85 105);
  }
</style>
