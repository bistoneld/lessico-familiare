---
import Layout from "../../layouts/BlogPost.astro";
import BannerStrip from "../../components/BannerStrip.astro";
import Hero from "../../components/Hero.astro";
import { getCollection } from "astro:content";

const base = import.meta.env.BASE_URL;
const heroImg = `${base}images/pages/LF_Blog.png`;
const fallbackCover = `${base}images/pages/LF_Home.png`;
const USE_NETLIFY_IMAGES = import.meta.env.PUBLIC_USE_NETLIFY_IMAGES === "true";

const toDate = (value) => (value instanceof Date ? value : new Date(value));
const resolveCover = (cover) => {
  if (!cover) return fallbackCover;
  if (cover.startsWith("/")) {
    return `${base}${cover.replace(/^\//, "")}`;
  }
  return cover;
};
const toRootPath = (url) => {
  if (!url) return "";
  if (url.startsWith("http")) return url;
  if (url.startsWith("/")) return url;
  if (url.startsWith(base)) return "/" + url.slice(base.length);
  return "/" + url.replace(/^\//, "");
};
const netlifyImg = (url, { w, q = 75 } = {}) => {
  const rootUrl = toRootPath(url);
  if (!USE_NETLIFY_IMAGES) return rootUrl;
  const params = new URLSearchParams();
  params.set("url", rootUrl);
  if (w) params.set("w", String(w));
  params.set("q", String(q));
  return `/.netlify/images?${params.toString()}`;
};
function getSlug(post) {
  return post.slug ?? post.id.replace(/\.(md|mdx)$/i, "");
}
const accents = ["#6B8CC3", "#7A9B6D", "#C08A5A", "#8F7BC2", "#4C7BBF"];

const posts = (await getCollection("blog"))
  .filter((post) => !post.data.draft)
  .sort((a, b) => {
    const dateA = toDate(a.data.date).valueOf();
    const dateB = toDate(b.data.date).valueOf();
    return dateB - dateA;
  });
---

<Layout title="Blog" description="Articoli e materiali di Lessico Familiare">
  <Hero
    eyebrow=" "
    title="Blog"
    subtitle="I rapporti umani: culture e percorsi di sviluppo"
    image={heroImg}
    imageAlt="Dettaglio di uno spazio di lavoro"
    align="left"
    size="md"
  />

  <section>
    <BannerStrip title="Articoli, materiali e tracce di lavoro" />
  </section>

  <section class="mt-10">
    <div class="max-w-3xl">
      <ul class="grid gap-6 md:grid-cols-2" data-blog-list>
        {posts.map((post, index) => {
          const accent = accents[index % accents.length];
          const isFeatured = index === 0;
          const slug = getSlug(post);
          return (
            <li
              class={`blog-card ${isFeatured ? "md:col-span-2" : ""}`}
              data-blog-item
              data-index={index}
            >
              <a
                href={`${base}blog/${slug}/`}
                class="group relative flex h-full flex-col overflow-hidden rounded-2xl border border-slate-200 bg-white transition hover:-translate-y-0.5 hover:shadow-md"
              >
                <div class="relative aspect-[16/9] overflow-hidden bg-slate-100">
                  {(() => {
                    const cover = resolveCover(post.data.cover);
                    const img640 = netlifyImg(cover, { w: 640 });
                    const img1280 = netlifyImg(cover, { w: 1280 });
                    return (
                      <picture>
                        <source
                          type="image/avif"
                          srcset={`${img640} 640w, ${img1280} 1280w`}
                          sizes="(max-width: 768px) 100vw, 50vw"
                        />
                        <source
                          type="image/webp"
                          srcset={`${img640} 640w, ${img1280} 1280w`}
                          sizes="(max-width: 768px) 100vw, 50vw"
                        />
                        <img
                          src={img1280}
                          alt={post.data.title}
                          class="h-full w-full object-cover transition duration-700 group-hover:scale-105"
                          loading="lazy"
                          style="color: var(--brand-dark)"
                          decoding="async"
                        />
                      </picture>
                    );
                  })()}
                  <div
                    class="absolute inset-0 opacity-80 transition group-hover:opacity-90"
                    style={`background: linear-gradient(120deg, ${accent}cc, rgba(0,0,0,0.15));`}
                  ></div>
                </div>
                <div class="p-5">
                  <h3 class="text-lg font-semibold" style="color: var(--brand-dark)">{post.data.title}</h3>
                  {post.data.excerpt && (
                    <p class="mt-2 text-sm text-slate-600" style="color: var(--brand-dark)">
                      {post.data.excerpt}
                    </p>
                  )}
                  <div class="mt-3 flex flex-wrap gap-2 text-xs text-slate-500">
                    <span>{toDate(post.data.date).toLocaleDateString("it-IT")}</span>
                    {post.data.tags?.map((tag) => (
                      <span class="rounded-full border border-slate-200 px-2 py-0.5">
                        {tag}
                      </span>
                    ))}
                  </div>
                </div>
                <div
                  class="pointer-events-none absolute inset-x-0 bottom-0 h-1 opacity-0 transition group-hover:opacity-100"
                  style={`background: ${accent};`}
                ></div>
              </a>
            </li>
          );
        })}
      </ul>
      <div class="mt-8 flex justify-center">
        <button
          type="button"
          class="inline-flex items-center justify-center rounded-xl border border-slate-300 px-5 py-3 text-sm font-semibold text-slate-700 hover:border-slate-400 hover:text-slate-900 transition"
          data-blog-load
        >
          Carica altri
        </button>
      </div>
    </div>
  </section>
</Layout>

<style>
  :global(main) {
    padding-top: 0;
  }

  .blog-card.is-hidden {
    display: none;
  }
</style>

<script>
  (() => {
    const list = document.querySelector("[data-blog-list]");
    const button = document.querySelector("[data-blog-load]");
    if (!list || !button) return;

    const items = Array.from(list.querySelectorAll("[data-blog-item]"));
    const initialCount = 11;
    const batchSize = 10;
    let visibleCount = initialCount;

    const update = () => {
      items.forEach((item, index) => {
        item.classList.toggle("is-hidden", index >= visibleCount);
      });
      if (visibleCount >= items.length) {
        button.setAttribute("hidden", "hidden");
      }
    };

    update();

    button.addEventListener("click", () => {
      visibleCount += batchSize;
      update();
    });
  })();
</script>
